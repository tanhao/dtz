{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\SocketIOManager.js"],"names":["cc","Class","extends","Component","properties","dataEventHandler","roomId","config","seats","round","creator","seatIndex","needCheckIp","onLoad","dispatchEvent","event","data","emit","initHandlers","self","th","sio","addHandler","log","JSON","stringify","getSeatIndexById","userManager","userId","index","online","ip","usereId","seat","getSeatByUserId","name","headImgUrl","sex","score","ready","vv","wc","show","director","loadScene","isOver","i","length","getLocalIndex","total","ret","getSeatIndexByID","getWanfa","str","push","peoples","gift","join","getDipai","liudipai","connectServer","onConnectSuccess","ping","hide","onConnectError","err","alert","addr","port","token","sign","time","connect"],"mappings":"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","file":"SocketIOManager.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        dataEventHandler:null, //处理socket.io发过来的数据的节点\r\n        roomId:null,\r\n        config:null,\r\n        seats:null,\r\n        round:null,\r\n        creator:null,\r\n        seatIndex:-1,\r\n        needCheckIp:false,\r\n    },\r\n\r\n\r\n    onLoad () {\r\n\r\n    },\r\n\r\n    /*\r\n    update (dt) {\r\n    },\r\n    */\r\n\r\n    dispatchEvent(event,data){\r\n        if(this.dataEventHandler){\r\n            this.dataEventHandler.emit(event,data);\r\n        }    \r\n    },\r\n\r\n    initHandlers:function(){\r\n        var self = this;\r\n        //连接成功初始化信息\r\n        th.sio.addHandler(\"init_room\",function(data){\r\n            cc.log(\"==>SocketIOManager init_room:\",JSON.stringify(data));\r\n            self.roomId=data.roomId;\r\n            self.config=data.config;\r\n            self.seats=data.seats;\r\n            self.round=data.round;\r\n            self.creator=data.creator;\r\n            self.seatIndex=self.getSeatIndexById(th.userManager.userId);\r\n            self.dispatchEvent(\"init_room\",data);\r\n        })\r\n        //其他玩家加入房间\r\n        th.sio.addHandler(\"join_push\",function(data){\r\n            cc.log(\"==>SocketIOManager init_room:\",JSON.stringify(data));\r\n            var index=data.index;\r\n            if(self.seats[index].userId){\r\n                self.seats[index].online = true;\r\n                if(self.seats[index].ip != data.ip){\r\n                    self.seats[index].ip = data.ip;\r\n                    self.needCheckIp=true;\r\n                }\r\n            }else{\r\n                self.seats[index] = data;\r\n                self.needCheckIp=true;\r\n            }\r\n            self.dispatchEvent(\"join_push\",self.seats[index]);\r\n            if(needCheckIp){\r\n                self.dispatchEvent('check_ip',self.seats[seatIndex]);\r\n            }\r\n        })\r\n\r\n        //其他玩家离开房间\r\n        th.sio.addHandler(\"leave_push\",function(data){\r\n            cc.log(\"==>SocketIOManager leave_push:\",JSON.stringify(data));\r\n            var userId=data.usereId;\r\n            var seat=self.getSeatByUserId(userId);\r\n            if(seat){\r\n                seat.userId=null;\r\n                seat.name=null;\r\n                seat.headImgUrl=null;\r\n                seat.sex=null;\r\n                seat.sex=null;\r\n                seat.score=0;\r\n                seat.ready=false;\r\n                seat.online=false;\r\n            }\r\n            self.dispatchEvent(\"leave_push\",seat);\r\n        })\r\n\r\n        //解散房间，所有玩家退出房间，收到此消息返回大厅\r\n        th.sio.addHandler(\"dissolve_push\",function(data){\r\n            self.roomId=null;\r\n            self.config=null;\r\n            self.seats=null;\r\n            self.round=null;\r\n            self.seatIndex=-1;\r\n            cc.log(\"==>SocketIOManager dissolve_push:\",JSON.stringify(data));\r\n            self.dispatchEvent(\"dissolve_push\",data);\r\n        })\r\n        //断线\r\n        th.sio.addHandler(\"disconnect\",function(data){\r\n            if(self.roomId == null){\r\n                cc.vv.wc.show('正在返回游戏大厅');\r\n                cc.director.loadScene(\"hall\");\r\n            }else{\r\n                if(self.isOver == false){\r\n                    th.userManager.roomId = self.roomId;\r\n                    self.dispatchEvent(\"disconnect\");                    \r\n                }else{\r\n                    self.roomId=null;\r\n                    self.config=null;\r\n                    self.seats=null;\r\n                    self.round=null;\r\n                    self.seatIndex=-1;\r\n                }\r\n            }\r\n        });\r\n       \r\n    },\r\n\r\n    getSeatIndexById:function(userId){\r\n        for(var i = 0; i < this.seats.length;i++){\r\n            if(this.seats[i].userId == userId){\r\n                return i;\r\n            }\r\n        }\r\n        return -1;\r\n    },\r\n\r\n    getLocalIndex:function(index){\r\n        var total=this.seats.length;\r\n        var ret = (index - this.seatIndex + total) % total;\r\n        return ret;\r\n    },\r\n\r\n    getSeatByUserId:function(userId){\r\n        var index = this.getSeatIndexByID(userId);\r\n        var seat = this.seats[index];\r\n        return seat;\r\n    },\r\n\r\n    getWanfa:function(){\r\n       var str=[];\r\n       str.push(this.config.peoples)\r\n       str.push(\"人\");\r\n       str.push(\" 结算\");\r\n       str.push(this.config.score)\r\n       str.push(\" 奖励\");\r\n       str.push(this.config.gift)\r\n       return str.join(\"\");\r\n    },\r\n    getDipai:function(){\r\n        return this.config.liudipai?(peoples==4?8:(peoples==3?9:0)):0;  \r\n    },\r\n\r\n\r\n    connectServer:function(data){\r\n        var onConnectSuccess=function(){\r\n            cc.director.loadScene(\"game\",function(){\r\n                th.sio.ping();\r\n                th.wc.hide();\r\n            });\r\n        }\r\n\r\n        var onConnectError=function(err){\r\n             th.wc.hide();\r\n             th.alert.show('提示',err,null,false); //\r\n        }\r\n        th.sio.addr=\"ws://\"+data.ip+\":\"+data.port+\"?roomId=\"+data.roomId+\"&token=\"+data.token+\"&sign=\"+data.sign+\"&time=\"+data.time;\r\n        th.sio.connect(onConnectSuccess,onConnectError);\r\n    }\r\n    \r\n\r\n});\r\n"]}